name: Security Scan

on:
  schedule:
    # æ¯å¤© UTC 00:00 (å°åŒ—æ™‚é–“ 08:00) åŸ·è¡Œ
    - cron: '0 0 * * *'
  push:
    branches: [main]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          # Try npm ci first, fallback to npm install if it fails
          npm ci || npm install
        continue-on-error: false
      
      - name: Run npm audit (production)
        run: npm audit --omit=dev --audit-level=moderate
        continue-on-error: true
      
      - name: Run npm audit (all)
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: Check for outdated packages
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || true
      
      - name: Generate audit report
        run: |
          echo "ğŸ”’ Security Audit Report" > audit-report.txt
          echo "Generated: $(date)" >> audit-report.txt
          echo "" >> audit-report.txt
          npm audit --production --json > audit-production.json || true
          npm audit --json > audit-all.json || true
          cat audit-report.txt
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            audit-report.txt
            audit-production.json
            audit-all.json
          retention-days: 30

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for secrets in code
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          # æ’é™¤å·²çŸ¥çš„ auth é‚è¼¯æª”æ¡ˆï¼ˆä¸å«çœŸå¯¦å¯†é‘°ï¼Œåªæ˜¯ token ç®¡ç†ç¨‹å¼ç¢¼ï¼‰
          EXCLUDE="--exclude=auth.ts --exclude=telegram-auth.ts --exclude=telegram-login.ts"
          if grep -r -E "(api[_-]?key|secret[_-]?key|password)[[:space:]]*=" $EXCLUDE --include="*.ts" --include="*.js" server/ src/ | grep -v "// safe" | grep -v "interface" | grep -v "type " ; then
            echo "âš ï¸  Warning: Potential secrets found in code"
            exit 1
          fi
          echo "âœ… No obvious secrets found"
      
      - name: Check for console.log in production code
        run: |
          echo "ğŸ” Checking for console.log..."
          if grep -r "console\.log" --include="*.ts" --include="*.tsx" src/ server/ | grep -v "// OK" | grep -v "debug"; then
            echo "âš ï¸  Warning: console.log found - should be removed or replaced with proper logging"
          else
            echo "âœ… No console.log in production code"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
